<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Dashboard</title>

    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Your CSS remains the same */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; padding-top: 64px;}
        .dashboard-container { max-width: 900px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background-color: #4a5568; color: white; padding: 15px 20px; font-size: 1.5em; font-weight: bold; }
        .controls { padding: 15px 20px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }
        .controls-label { font-weight: bold; }
        .stall-selector, .timeframe-selector button { padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 6px; background-color: #fff; font-size: 0.9em; cursor: pointer; }
        .timeframe-selector button.active { background-color: #2c5282; color: white; border-color: #2c5282; }
        .main-display { padding: 20px; }
        .stall-header { font-size: 1.8em; font-weight: bold; margin-bottom: 20px; }
        .status-indicator { display: inline-block; margin-left: 10px; font-size: 0.8em; font-weight: normal; }
        .status-indicator .dot { height: 12px; width: 12px; background-color: #48bb78; border-radius: 50%; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .kpi-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; }
        .kpi-card { background-color: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: center; flex: 1; }
        .kpi-card .title { font-size: 0.8em; font-weight: bold; color: #718096; text-transform: uppercase; margin-bottom: 10px; }
        .kpi-card .value { font-size: 2em; font-weight: bold; color: #2d3748; }
        .chart-container { position: relative; }
        .chart-title { font-weight: bold; margin-bottom: 10px; }

        .controls{
            display:flex;               /* lay children out in one row            */
            align-items:center;         /* vertically center everything           */
            gap:12px;                   /* little breathing room between pieces   */
        }

        /* push the whole group to the far right */
        .export-group{
            margin-left:auto;          /* consumes all leftover space */
            display:flex;
            align-items:center;
            gap:8px;                   /* space between buttons */
        }

        .export-btn{
            margin:0;                   /* kill the old top-margin                */
            padding:10px 18px;
            font-weight:600;
            text-decoration:none;
            color:#fff;
            background:#3182ce;
            border-radius:6px;
            transition:background-color .15s ease;
        }
        .export-btn:hover{ background:#225ea8; }
    </style>
</head>
<body>

{% include 'navbar.html' %}   <!-- top navigation bar -->

<div class="dashboard-container">
    <div class="header">üÖøÔ∏è Parking Dashboard</div>
    
    <div class="controls">
        <span class="controls-label">Stall:</span>
        <select id="stall-selector" class="stall-selector"></select>

        <span class="controls-label">Timeframe:</span>
        <div class="timeframe-selector">
            <button id="btn-7days" class="active">7 Days</button>
            <button id="btn-30days">30 Days</button>
            <button id="btn-12months">12 Months</button>
            <button id="btn-all">All Time</button>
        </div>

        <div class="export-group">
            <a id="export-csv-btn" href="#" download class="export-btn">‚¨á Export</a>
            <a id="export-all-zip-btn" href="#" download class="export-btn">‚¨á Export ALL (ZIP)</a>
        </div>
    </div>

    <div class="main-display">
        <div id="stall-header" class="stall-header">
            </div>

        <div class="kpi-container">
            <div class="kpi-card"><div class="title">Total Duration</div><div class="value" id="kpi-total">...</div></div>
            <div class="kpi-card"><div class="title">Avg Daily Duration</div><div class="value" id="kpi-avg">...</div></div>
            <div class="kpi-card"><div class="title">Busiest Day</div><div class="value" id="kpi-busiest">...</div></div>
        </div>
        
        <div id="chart-title" class="chart-title"></div>
        <div class="chart-container">
            <canvas id="occupancyChart"></canvas>
        </div>
    </div>
</div>

<script>
    // --- DOM Elements ---
    const stallSelector = document.getElementById('stall-selector');
    const timeframeSelector = document.querySelector('.timeframe-selector');
    const chartCanvas = document.getElementById('occupancyChart').getContext('2d');
    const exportBtn = document.getElementById('export-csv-btn');
    const exportAllZipBtn = document.getElementById('export-all-zip-btn');

    const TIMEFRAMES = {
    'btn-7days'    : 7,      // 1 week
    'btn-30days'   : 30,     // ~1 month
    'btn-12months' : 365,    // 12 months (you can change to 360/366)
    'btn-all'      : null    // special value ‚Üí ‚Äúall time‚Äù
    };

    // --- State Variables ---
    let occupancyChart;
    let currentStallId = null;
    let currentTimeframe = TIMEFRAMES['btn-7days']; // Default to 7 days

    // --- Chart Rendering ---
    function renderChart(data, labels) {
        if (occupancyChart) {
            occupancyChart.destroy();
        }
        occupancyChart = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Occupied Hours', data: data, backgroundColor: '#4299e1' }]
            },
            options: {
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- Data Fetching and UI Update ---
    async function updateDashboard() {
        if (!currentStallId) return;

        let url = `/api/stall-history?stall_id=${currentStallId}`;
        if (typeof currentTimeframe === 'number') {
            url += `&days=${currentTimeframe}`;      // 7, 30, 365
        } else {
            url += `&days=all`;                      // null ‚Üí all time
        }

        // Fetch data from the new history endpoint
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response failed');
            const data = await response.json();

            // Update KPIs
            document.getElementById('kpi-total').textContent = data.kpi.total;
            document.getElementById('kpi-avg').textContent = data.kpi.avg;
            document.getElementById('kpi-busiest').textContent = data.kpi.busiest;

            // Update Titles
            const stallText = stallSelector.options[stallSelector.selectedIndex].text;
            let tfLabel;
            if (currentTimeframe === 365)      tfLabel = 'Past 12 Months';
            else if (currentTimeframe === 30)  tfLabel = 'Past 30 Days';
            else if (currentTimeframe === 7)   tfLabel = 'Past 7 Days';
            else                               tfLabel = 'All Time';

            document.getElementById('stall-header').textContent = `Stall ${stallText}`;
            document.getElementById('chart-title').textContent  = `Daily Occupancy for ${stallText} (${tfLabel})`;
            
            // Render Chart
            renderChart(data.data, data.labels);
        } catch (error) {
            console.error('Failed to update dashboard:', error);
            document.getElementById('chart-title').textContent = 'Error: Could not load data.';
        }
    }

    // --- Initial Population of the Dropdown ---
    async function populateStallSelector() {
        try {
            
            const pathParts = window.location.pathname.split('/');
            
            const defaultStallId = pathParts[pathParts.length - 1];
            const response = await fetch('/api/get-stall-numbers?lot_id=1'); // Assuming lot_id=1
            const stalls = await response.json();

            if (stalls && stalls.length > 0) {
                stallSelector.innerHTML = ''; // Clear existing options
                stalls.forEach(stall => {
                    const option = document.createElement('option');
                    option.value = stall.id;
                    option.textContent = `${stall.number}`;
                    stallSelector.appendChild(option);
                });

                if (defaultStallId) {
                    stallSelector.value = defaultStallId;
                }
                
                // Set the initial stall and load its data
                currentStallId = stallSelector.value;
                updateDashboard();
            } else {
                stallSelector.innerHTML = '<option>No stalls found</option>';
            }
        } catch (error) {
            console.error('Failed to populate stalls:', error);
        }
    }

    function buildExportUrl () {
        const daysParam = (typeof currentTimeframe === 'number')
                            ? currentTimeframe          // 7, 30, 365
                            : 'all';                    // null ‚Üí "all"
        const lotId = 1; // hardcoded for now
        return `/api/stall_history_csv?lot_id=${lotId}&stall_id=${currentStallId}&days=${daysParam}`;
    }

    function buildBulkExportZipUrl () {
        const daysParam = (typeof currentTimeframe === 'number') ? currentTimeframe : 'all';
        const lotId = 1; // hardcoded for now
        return `/api/stall_histories_zip?lot_id=${lotId}&days=${daysParam}`;
    }

    // --- Event Listeners ---
    stallSelector.addEventListener('change', (e) => {
        currentStallId = e.target.value;
        // 1. Construct the new URL path
        const newUrl = `/dashboard/stall/${currentStallId}`;
        
        // 2. Update the browser's URL without reloading the page
        history.pushState({stallId: currentStallId}, '', newUrl);


        updateDashboard();
    });

    timeframeSelector.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        
        currentTimeframe = TIMEFRAMES[e.target.id];
        
        // Update active button style
        document.querySelectorAll('.timeframe-selector button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');

        updateDashboard();
    });

    exportBtn.addEventListener('pointerdown', () => {
        exportBtn.href = buildExportUrl();
    });

    if (exportAllZipBtn) {
        exportAllZipBtn.addEventListener('pointerdown', () => {
        exportAllZipBtn.href = buildBulkExportZipUrl();
        });
    }
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        populateStallSelector();
    });
</script>

</body>
</html>